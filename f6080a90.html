<!DOCTYPE html><html><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type" /><meta content="width=device-width, initial-scale=1" name="viewport" /><!--replace-start-0--><!--replace-start-5--><!--replace-start-8--><title>Fixing contract timeouts in Glow - My Zettelkasten</title><!--replace-end-8--><!--replace-end-5--><!--replace-end-0--><link href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css" rel="stylesheet" /><link href="https://fonts.googleapis.com/css?family=Merriweather|Libre+Franklin|Roboto+Mono&amp;display=swap" rel="stylesheet" /><!--replace-start-1--><!--replace-start-4--><!--replace-start-7--><link href="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" rel="icon" /><meta content="Issue" name="description" /><link href="https://kwannoel.xyz/f6080a90.html" rel="canonical" /><meta content="Fixing contract timeouts in Glow" property="og:title" /><meta content="My Zettelkasten" property="og:site_name" /><meta content="article" property="og:type" /><meta content="f6080a90" property="neuron:zettel-id" /><meta content="f6080a90" property="neuron:zettel-slug" /><meta content="stub" property="neuron:zettel-tag" /><script type="application/ld+json">[]</script><style type="text/css">body{background-color:#eeeeee !important;font-family:"Libre Franklin", serif !important}body .ui.container{font-family:"Libre Franklin", serif !important}body h1, h2, h3, h4, h5, h6, .ui.header, .headerFont{font-family:"Merriweather", sans-serif !important}body code, pre, tt, .monoFont{font-family:"Roboto Mono","SFMono-Regular","Menlo","Monaco","Consolas","Liberation Mono","Courier New", monospace !important}body div.z-index p.info{color:#808080}body div.z-index ul{list-style-type:square;padding-left:1.5em}body div.z-index .uplinks{margin-left:0.29999em}body .zettel-content h1#title-h1{background-color:rgba(165,103,63,0.1)}body nav.bottomPane{background-color:rgba(165,103,63,2.0e-2)}body div#footnotes{border-top-color:#a5673f}body p{line-height:150%}body img{max-width:100%}body .deemphasized{font-size:0.94999em}body .deemphasized:hover{opacity:1}body .deemphasized:not(:hover){opacity:0.69999}body .deemphasized:not(:hover) a{color:#808080 !important}body div.container.universe{padding-top:1em}body div.zettel-view ul{padding-left:1.5em;list-style-type:square}body div.zettel-view .pandoc .highlight{background-color:#ffff00}body div.zettel-view .pandoc .ui.disabled.fitted.checkbox{margin-right:0.29999em;vertical-align:middle}body div.zettel-view .zettel-content .metadata{margin-top:1em}body div.zettel-view .zettel-content .metadata div.date{text-align:center;color:#808080}body div.zettel-view .zettel-content h1{padding-top:0.2em;padding-bottom:0.2em;text-align:center}body div.zettel-view .zettel-content h2{border-bottom:solid 1px #4682b4;margin-bottom:0.5em}body div.zettel-view .zettel-content h3{margin:0px 0px 0.4em 0px}body div.zettel-view .zettel-content h4{opacity:0.8}body div.zettel-view .zettel-content div#footnotes{margin-top:4em;border-top-style:groove;border-top-width:2px;font-size:0.9em}body div.zettel-view .zettel-content div#footnotes ol > li > p:only-of-type{display:inline;margin-right:0.5em}body div.zettel-view .zettel-content aside.footnote-inline{width:30%;padding-left:15px;margin-left:15px;float:right;background-color:#d3d3d3}body div.zettel-view .zettel-content .overflows{overflow:auto}body div.zettel-view .zettel-content code{margin:auto auto auto auto;font-size:100%}body div.zettel-view .zettel-content p code, li code, ol code{padding:0.2em 0.2em 0.2em 0.2em;background-color:#f5f2f0}body div.zettel-view .zettel-content pre{overflow:auto}body div.zettel-view .zettel-content dl dt{font-weight:bold}body div.zettel-view .zettel-content blockquote{background-color:#f9f9f9;border-left:solid 10px #cccccc;margin:1.5em 0px 1.5em 0px;padding:0.5em 10px 0.5em 10px}body div.zettel-view .zettel-content.raw{background-color:#dddddd}body .ui.label.zettel-tag{color:#000000}body .ui.label.zettel-tag a{color:#000000}body nav.bottomPane ul.backlinks > li{padding-bottom:0.4em;list-style-type:disc}body nav.bottomPane ul.context-list > li{list-style-type:lower-roman}body .footer-version img{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%)}body .footer-version img:hover{-webkit-filter:grayscale(0%);-moz-filter:grayscale(0%);-ms-filter:grayscale(0%);-o-filter:grayscale(0%);filter:grayscale(0%)}body .footer-version, .footer-version a, .footer-version a:visited{color:#808080}body .footer-version a{font-weight:bold}body .footer-version{margin-top:1em !important;font-size:0.69999em}@media only screen and (max-width: 768px){body div#zettel-container{margin-left:0.4em !important;margin-right:0.4em !important}}body span.zettel-link-container span.zettel-link a{color:#a5673f;font-weight:bold;text-decoration:none}body span.zettel-link-container span.zettel-link a:hover{background-color:rgba(165,103,63,0.1)}body span.zettel-link-container span.extra{color:auto}body span.zettel-link-container.errors{border:solid 1px #ff0000}body span.zettel-link-container.errors span.zettel-link a:hover{text-decoration:none !important;cursor:not-allowed}body [data-tooltip]:after{font-size:0.69999em}body div.tag-tree div.node{font-weight:bold}body div.tag-tree div.node a.inactive{color:#555555}body .tree.flipped{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}body .tree{overflow:auto}body .tree ul.root{padding-top:0px;margin-top:0px}body .tree ul{position:relative;padding:1em 0px 0px 0px;white-space:nowrap;margin:0px auto 0px auto;text-align:center}body .tree ul::after{content:"";display:table;clear:both}body .tree ul:last-child{padding-bottom:0.1em}body .tree li{display:inline-block;vertical-align:top;text-align:center;list-style-type:none;position:relative;padding:1em 0.5em 0em 0.5em}body .tree li::before{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{content:"";position:absolute;top:0px;right:50%;border-top:solid 2px #cccccc;width:50%;height:1.19999em}body .tree li::after{right:auto;left:50%;border-left:solid 2px #cccccc}body .tree li:only-child{padding-top:0em}body .tree li:only-child::after{display:none}body .tree li:only-child::before{display:none}body .tree li:first-child::before{border-style:none;border-width:0px}body .tree li:first-child::after{border-radius:5px 0px 0px 0px}body .tree li:last-child::after{border-style:none;border-width:0px}body .tree li:last-child::before{border-right:solid 2px #cccccc;border-radius:0px 5px 0px 0px}body .tree ul ul::before{content:"";position:absolute;top:0px;left:50%;border-left:solid 2px #cccccc;width:0px;height:1.19999em}body .tree li div.forest-link{border:solid 2px #cccccc;padding:0.2em 0.29999em 0.2em 0.29999em;text-decoration:none;display:inline-block;border-radius:5px 5px 5px 5px;color:#333333;position:relative;top:2px}body .tree.flipped li div.forest-link{-webkit-transform:rotate(180deg);-moz-transform:rotate(180deg);-ms-transform:rotate(180deg);-o-transform:rotate(180deg);transform:rotate(180deg)}</style><script async="" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" rel="stylesheet" /><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-core.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/plugins/autoloader/prism-autoloader.min.js"></script><!--replace-end-7--><!--replace-end-4--><!--replace-end-1--></head><body><div class="ui fluid container universe"><!--replace-start-2--><!--replace-start-3--><!--replace-start-6--><div class="ui text container" id="zettel-container" style="position: relative"><div class="zettel-view"><article class="ui raised attached segment zettel-content"><div class="pandoc"><h1 id="title-h1">Fixing contract timeouts in Glow</h1><p><a href="https://gitlab.com/mukn/glow/-/issues/195">Issue</a></p><h2 id="scenario">Scenario</h2><p>Bob wants to pay Alice to sign a document.</p><pre><code class="js language-js">#lang glow

@interaction([Buyer, Seller])
let payForSignature = (digest : Digest, price : Nat) =&gt; {
  deposit! Buyer -&gt; price;

  @publicly!(Seller) let signature = sign(digest);
  // The line above is equivalent to the three below:
  //// @verifiably!(Seller) let signature = sign(digest);
  //// publish! Seller -&gt; signature;
  //// verify! signature; // This line is itself the same as the one below:
  ////// require! isValidSignature(Seller, signature, digest);

  withdraw! Seller &lt;- price;
  return signature;
};</code></pre><p>After we publish, the seller verifies the signature.</p><p>The corresponding glow-asm is:</p><pre><code class="language-none">(set-participant Seller)
(def signature (sign digest0))
(add-to-publish &#39;signature signature)
(def tmp (@app isValidSignature Seller digest0 signature))
(require! tmp)
(@debug-label dlb2)
(participant:withdraw Seller price)
(return (@tuple))
(@label end0)</code></pre><p>The problem is that at the final step, after Seller returns, Buyer does not, until it timeouts.</p><p>It should watch for logs and immediately return instead of waiting.</p><p>How do we change this?</p><p>We first need to understand Glow’s execution model.</p><p>A Glow contract is first deployed and then blocks are ran.</p><p>Each block has an “active participant”, in the case of the above code block, the active participant is the Seller.</p><p>To sequence execution we perform “handshakes”, which toggle the active participant. whenever we hit an interaction boundary, to wait for the right participant to run their actions.</p><p>This is done off-chain, by sending an agreement to the other participant.</p><p><strong>ASSUMPTION</strong></p><p>When running the interaction, we specify which participant we are. With this information, we find the first unexecuted codeblock for which we are the active participant, and run it to completion / until another boundary.</p><p>Each code block is ran by the active participant. You can see this from <code>(set-participant Seller)</code>.</p><p>We also have “passive” participants, who listen for changes.</p><p>There are 2 sorts: “handshake” and “contract”.</p><p>“handshake” is when a participant is waiting for the other participant to send over the handshake.</p><p>“contract” is when a participant is not waiting for a handshake.</p><p>How are this changes detected? We use the JSON-RPC to watch for events. <strong>(TODO further details)</strong></p><p>Currently this is not implemented properly, because when the Seller is done with their execution, the Buyer is still waiting for the Seller to be done, when it should have exited.</p><p>Following could be happening:</p><ul><li>Buyer not parsing the event properly</li><li>Seller not emitting an event when it is done</li></ul><p>As such we need to look into the following parts of the Glow Compiler / Runtime:</p><p>Runtime -&gt; passive-code-block -&gt; watch event -&gt; JSON-RPC</p><h2 id="debugging-the-code">Debugging the code</h2><p>We should have a cheap way of reproducing this.</p><p>We can do this by writing some integration tests for Buyer, Seller parts of the runtime.</p><h2 id="the-integration-tests">The integration tests</h2><p>The integration test should test the following sequence of instructions:</p><ol><li>Seller emitting an event</li><li>Buyer listening for the said event</li></ol><p>If we want to be more specific:</p><ol><li>Emit Seller signing event.</li></ol><p>What are we emitting exactly? How is it emitted?</p><ol start="2"><li>Buyer listen for the signing event.</li></ol><p>How is watch implemented. What are we watching for exactly?</p><p>Relevant code is in <code>participant-runtime.ss</code>.</p><p>After review it appears we can and should also test the <code>watch</code> function.</p><h2 id="understanding-evm-runtime-better">Understanding EVM runtime better</h2><p>The following is a high level overview of our calling convention:</p><ol><li>Setup call frame, pc, etc…</li><li>Run codeblock(s)</li><li>Save digest to persistent state</li><li>log published data about whether to continue and commit transaction.</li></ol><h2 id="why-do-we-log-stuff">Why do we LOG stuff?</h2><p>We want to understand when evaluation should stop. We want to know what information has been published. This is passed off-chain via an <code>agreement</code>, which allows the buyer to interrupt execution, and on-chain as well. The contract</p><h2 id="what-i-am-still-confused-by">What I am still confused by</h2><p>What is a transaction, how are we interfacing with one in Glow? See how <code>geth</code> implements it. Why are we digesting frames? How do we use these digests? Why is define-consecutive-addresses doing in evm-runtime, what is <code>with-id</code>? Recap <code>define-rule</code> in gerbil scheme.</p><h2 id="extras">Extras</h2><p>A related but separate issue would be <code>watch</code>, which should be eventually fixed to properly timeout as well.</p></div><div class="metadata"><div class="date" title="Zettel date"><time datetime="2021-06-07T17:38">2021-06-07</time></div></div></article><nav class="ui attached segment deemphasized bottomPane" id="neuron-tags-pane"><div><span class="ui basic label zettel-tag" title="Tag">stub</span></div></nav><nav class="ui bottom attached icon compact inverted menu brown" id="neuron-nav-bar"><!--replace-start-9--><a class="item" href="." title="Home"><i class="home icon"></i></a><!--replace-end-9--><a class="item" href="https://github.com/kwannoel/mind/edit/master/./f6080a90.md" title="Edit this page"><i class="edit icon"></i></a><a class="right item" href="impulse.html" title="Open Impulse"><i class="wave square icon"></i></a></nav></div></div><!--replace-end-6--><!--replace-end-3--><!--replace-end-2--><div class="ui center aligned container footer-version"><div class="ui tiny image"><a href="https://neuron.zettel.page"><img alt="logo" src="https://raw.githubusercontent.com/srid/neuron/master/assets/neuron.svg" title="Generated by Neuron 1.9.35.3" /></a></div></div></div></body></html>